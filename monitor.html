<!DOCTYPE html>

<html lang="en">
<head>

    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script><!-- Latest compiled and minified CSS -->
    <link href=
    "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
    rel="stylesheet">
    <script src=
    "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src=
    "https://cdnjs.cloudflare.com/ajax/libs/canvasjs/1.7.0/canvasjs.min.js"></script>
    <script src="web_utils/circle-progress.js" type="text/javascript"></script>
    <link href="web_utils/style.css" rel="stylesheet">

    <title>Char-RNN Monitoring Page</title>
</head>

<body>
    <div class="center">
        <div class="page-header">
            <h1>Char-RNN Training <small>Monitoring Page</small></h1>
        </div>

        <div class="row">
            <div class="col-md-4">
                <h4>Training Loss:</h4>

                <div class="training_loss">
                    <h4>Processing....</h4>
                </div><div id="chartContainer" style="margin-left: 40px; height: 400px; width: 400;"></div></canvas>

                <h5>Epoch</h5>
            </div>

            <div class="col-md-4">
                <h4>Progress of current epoch</h4>

                <div id="circle"></div>

                <h4>Current epoch:</h4>

                <div class="current_epoch">
                    <h4>0</h4>
                </div>

                <h4>Current iteration:</h4>

                <div class="current_iter">
                    <h4>0</h4>
                </div>
            </div>

            <div class="col-md-4">
                <h3>Time per batch:</h3>

                <div class="time_per_batch">
                    <h3>0s </h3>
                </div>
            </div>
        </div><br>

        <h4>Completion</h4>

        <div class="container">
            <div class="progress">
                <div class="progress-bar progress-bar-striped active" id="bar"
                style="width: 0%;">
                    0%
                </div>
            </div>
        </div>
    </div><script>
     $.ajaxSetup({ cache: false });
         var labelData = [];
         var trainingValueData = [];
         var current_training_loss;
         function initGraph(){
            $.get('web_utils/train.txt', function(data) {
            labelData.length = 0;
            trainingValueData.length = 0;
            var previous;
               var lines = data.split("\n");
                 for (var i = 0, len = lines.length; i < len; i++) {
                   if (i == 0){
                     continue;
                   }
                   if (i == 1){
                   var value = lines[i].split(":")[1];
                   previous = value;
                   labelData.push("");
                   trainingValueData.push(value);
                 }
                 else {
                  var epoch = lines[i].split(":")[0];
                  var value = lines[i].split(":")[1];
                  if (i+1 == lines.length){
                    current_training_loss = value;
                    $(".training_loss").text(current_training_loss);
                   }
                  if (((previous + 0.01) < value) || ((previous - 0.01) > value)) { // Check if previous data point is within 0.2 of next one
                    previous = value;
                    continue;

                  }
                   else {
                   previous = value;
                   labelData.push(epoch);
                   trainingValueData.push(value);
                   }
                 }
                 }
           }, 'text'); 
         }
        
         function graph(){
           initGraph();
           var data = [];
           for (var i = 0; i < labelData.length; i++){
            var object = {};
            object["x"] = Number(labelData[i]);
            object["y"] = Number(trainingValueData[i]);
            data.push(object);

           }
           var chart = new CanvasJS.Chart("chartContainer",
    {

       data: [
      {
        type: "line",

        dataPoints: 
        data
        
      }
      ]
    });

    chart.render();
         }
          $('#circle').circleProgress({
                 value: 0.00,
                 size: 280,
                 fill: {
                     gradient: ["#00688B", "#00B2EE"]
                 }
             });
         
         function update() {
            $.get('web_utils/data.txt', function(data) {
               var lines = data.split("\n");
               var iter;
                 for (var i = 0, len = lines.length; i < len; i++) {
                     if (i == 1){
                       $('.current_epoch').text(lines[i]); // Update current epoch
                       var decimal = lines[i].split('.')[1]
                       if (decimal.length == 2){
                        decimal = decimal + 0;
                       }
                       else if (decimal.length == 1){
                        decimal = decimal + 00;
                       }
                       var percent = decimal / 1000;
                         $('#circle').circleProgress('value', decimal / 1000);
                      
                     }
                     else if (i == 2){
                       $('.current_iter').text(lines[i]); // Update current iteration
                       iter = lines[i];
                     }
                     else if (i == 3){
                         var percent = Math.round((iter / lines[i]) * 10000) / 100;
                         $('#bar').text(percent + '%')
                         $('#bar').attr('aria-valuenow', percent);
                         $('#bar').css("width", percent + "%")
                     }
                     else if (i == 4){
                        $('.time_per_batch').text(lines[i] + "s"); // Update time per batch
                     }
                 }
         }, 'text');
         }
         $(window).load(function() {
          update();
           });         
         window.setInterval(function(){
          update();
         }, 3000);
         window.setInterval(function(){
          graph();
         }, 2000);
    </script>
</body>
</html>